<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥è¯¢å†å² - TaraxaåŒºå—é“¾è´¦æˆ·æŸ¥è¯¢å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 50%, #1a365d 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #319795, #ed8936);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .network-bg {
            background-image: url('resources/network-bg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .history-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .empty-state {
            opacity: 0.6;
        }
    </style>
</head>
<body class="network-bg">
    <!-- å¯¼èˆªæ  -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass-effect">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="resources/taraxa-logo.png" alt="Taraxa" class="h-8 w-auto mr-3">
                    <h1 class="text-xl font-bold text-white">TaraxaæŸ¥è¯¢å™¨</h1>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-white hover:text-teal-300 transition-colors">é¦–é¡µ</a>
                    <a href="about.html" class="text-white hover:text-teal-300 transition-colors">å…³äº</a>
                    <a href="history.html" class="text-teal-300 font-medium">å†å²è®°å½•</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="text-white">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- ç§»åŠ¨ç«¯èœå• -->
        <div id="mobile-menu" class="hidden md:hidden glass-effect">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="index.html" class="block px-3 py-2 text-white hover:text-teal-300">é¦–é¡µ</a>
                <a href="about.html" class="block px-3 py-2 text-white hover:text-teal-300">å…³äº</a>
                <a href="history.html" class="block px-3 py-2 text-teal-300 font-medium">å†å²è®°å½•</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="pt-20 pb-12">
        <!-- HeroåŒºåŸŸ -->
        <section class="py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 floating-animation">
                        æŸ¥è¯¢å†å²è®°å½•
                    </h1>
                    <p class="text-xl md:text-2xl text-gray-200 mb-8 max-w-3xl mx-auto">
                        æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰æŸ¥è¯¢è®°å½•ï¼Œè½»æ¾ç®¡ç†æ‚¨çš„Taraxaè´¦æˆ·ä¿¡æ¯
                    </p>
                </div>
            </div>
        </section>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <section class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold gradient-text mb-2" id="total-queries">0</div>
                        <div class="text-gray-300">æ€»æŸ¥è¯¢æ¬¡æ•°</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold gradient-text mb-2" id="unique-addresses">0</div>
                        <div class="text-gray-300">æŸ¥è¯¢åœ°å€æ•°</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold gradient-text mb-2" id="avg-balance">0.00</div>
                        <div class="text-gray-300">å¹³å‡ä½™é¢ (TARA)</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold gradient-text mb-2" id="last-query">ä»æœª</div>
                        <div class="text-gray-300">æœ€åæŸ¥è¯¢</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- å›¾è¡¨å±•ç¤º -->
        <section class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="glass-effect rounded-2xl p-8 mb-12">
                    <h2 class="text-2xl font-bold text-white mb-6 text-center">æŸ¥è¯¢è¶‹åŠ¿åˆ†æ</h2>
                    <div id="history-chart" style="height: 400px;"></div>
                </div>
            </div>
        </section>

        <!-- å†å²è®°å½•åˆ—è¡¨ -->
        <section class="py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="glass-effect rounded-2xl p-8">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-white">æŸ¥è¯¢è®°å½•</h2>
                        <div class="flex space-x-4">
                            <button id="export-btn" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg transition-colors">
                                å¯¼å‡ºæ•°æ®
                            </button>
                            <button id="clear-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                æ¸…ç©ºè®°å½•
                            </button>
                        </div>
                    </div>
                    
                    <!-- æœç´¢å’Œç­›é€‰ -->
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    id="search-input" 
                                    placeholder="æœç´¢åœ°å€..."
                                    class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-teal-400 focus:outline-none"
                                >
                            </div>
                            <select id="sort-select" class="px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-teal-400 focus:outline-none">
                                <option value="time-desc">æ—¶é—´é™åº</option>
                                <option value="time-asc">æ—¶é—´å‡åº</option>
                                <option value="balance-desc">ä½™é¢é™åº</option>
                                <option value="balance-asc">ä½™é¢å‡åº</option>
                            </select>
                        </div>
                    </div>

                    <!-- å†å²è®°å½•åˆ—è¡¨ -->
                    <div id="history-list">
                        <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="empty-state" class="empty-state text-center py-12 hidden">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <h3 class="text-xl font-bold text-white mb-2">æš‚æ— æŸ¥è¯¢è®°å½•</h3>
                        <p class="text-gray-400 mb-6">å¼€å§‹æŸ¥è¯¢Taraxaè´¦æˆ·ä½™é¢ï¼Œè®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        <a href="index.html" class="inline-block bg-teal-500 hover:bg-teal-600 text-white px-6 py-3 rounded-lg transition-colors">
                            å¼€å§‹æŸ¥è¯¢
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- é¡µè„š -->
    <footer class="glass-effect py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="flex items-center justify-center mb-4">
                    <img src="resources/taraxa-logo.png" alt="Taraxa" class="h-6 w-auto mr-2">
                    <span class="text-white font-bold">TaraxaåŒºå—é“¾æŸ¥è¯¢å™¨</span>
                </div>
                <p class="text-gray-400 text-sm">
                    Â© 2024 TaraxaåŒºå—é“¾è´¦æˆ·æŸ¥è¯¢å™¨. ä¸ºTaraxaç”Ÿæ€ç³»ç»Ÿæä¾›ä¸“ä¸šæŸ¥è¯¢æœåŠ¡
                </p>
            </div>
        </div>
    </footer>

    <script>
        // å†å²è®°å½•ç®¡ç†ç±»
        class HistoryManager {
            constructor() {
                this.history = this.loadHistory();
                this.filteredHistory = [...this.history];
                this.chart = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateStatistics();
                this.renderHistoryList();
                this.initChart();
                this.animateElements();
            }

            setupEventListeners() {
                // ç§»åŠ¨ç«¯èœå•
                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                    document.getElementById('mobile-menu').classList.toggle('hidden');
                });

                // æœç´¢åŠŸèƒ½
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.filterHistory(e.target.value);
                });

                // æ’åºåŠŸèƒ½
                document.getElementById('sort-select').addEventListener('change', (e) => {
                    this.sortHistory(e.target.value);
                });

                // å¯¼å‡ºåŠŸèƒ½
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportHistory();
                });

                // æ¸…ç©ºåŠŸèƒ½
                document.getElementById('clear-btn').addEventListener('click', () => {
                    this.clearHistory();
                });

                // å†å²è®°å½•ç‚¹å‡»
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('requery-btn')) {
                        const address = e.target.dataset.address;
                        this.requeryAddress(address);
                    }
                    if (e.target.classList.contains('copy-btn')) {
                        const address = e.target.dataset.address;
                        this.copyAddress(address);
                    }
                });
            }

            loadHistory() {
                const saved = localStorage.getItem('taraxa-query-history');
                return saved ? JSON.parse(saved) : [];
            }

            saveHistory() {
                localStorage.setItem('taraxa-query-history', JSON.stringify(this.history));
            }

            updateStatistics() {
                const totalQueries = this.history.length;
                const uniqueAddresses = new Set(this.history.map(item => item.address)).size;
                const avgBalance = totalQueries > 0 ? 
                    this.history.reduce((sum, item) => sum + item.balance, 0) / totalQueries : 0;
                const lastQuery = totalQueries > 0 ? 
                    new Date(this.history[0].timestamp).toLocaleDateString() : 'ä»æœª';

                document.getElementById('total-queries').textContent = totalQueries;
                document.getElementById('unique-addresses').textContent = uniqueAddresses;
                document.getElementById('avg-balance').textContent = avgBalance.toFixed(2);
                document.getElementById('last-query').textContent = lastQuery;
            }

            filterHistory(searchTerm) {
                if (!searchTerm.trim()) {
                    this.filteredHistory = [...this.history];
                } else {
                    this.filteredHistory = this.history.filter(item =>
                        item.address.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                this.renderHistoryList();
            }

            sortHistory(sortType) {
                switch (sortType) {
                    case 'time-desc':
                        this.filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        break;
                    case 'time-asc':
                        this.filteredHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        break;
                    case 'balance-desc':
                        this.filteredHistory.sort((a, b) => b.balance - a.balance);
                        break;
                    case 'balance-asc':
                        this.filteredHistory.sort((a, b) => a.balance - b.balance);
                        break;
                }
                this.renderHistoryList();
            }

            renderHistoryList() {
                const container = document.getElementById('history-list');
                const emptyState = document.getElementById('empty-state');

                if (this.filteredHistory.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                
                container.innerHTML = this.filteredHistory.map((item, index) => `
                    <div class="history-card glass-effect rounded-lg p-6 mb-4" data-index="${index}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div class="flex-1 mb-4 md:mb-0">
                                <div class="flex items-center mb-2">
                                    <div class="w-3 h-3 bg-teal-400 rounded-full mr-3"></div>
                                    <span class="text-sm text-gray-400">${new Date(item.timestamp).toLocaleString()}</span>
                                </div>
                                <div class="text-white font-mono text-lg mb-2 break-all">${item.address}</div>
                                <div class="flex items-center">
                                    <span class="text-2xl font-bold gradient-text">${item.balance.toFixed(6)}</span>
                                    <span class="text-teal-400 ml-2">TARA</span>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button class="requery-btn bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg transition-colors" data-address="${item.address}">
                                    é‡æ–°æŸ¥è¯¢
                                </button>
                                <button class="copy-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors" data-address="${item.address}">
                                    å¤åˆ¶åœ°å€
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            initChart() {
                const chartContainer = document.getElementById('history-chart');
                this.chart = echarts.init(chartContainer);

                if (this.history.length === 0) {
                    this.chart.setOption({
                        title: {
                            text: 'æš‚æ— æ•°æ®',
                            left: 'center',
                            top: 'middle',
                            textStyle: {
                                color: '#9CA3AF',
                                fontSize: 18
                            }
                        }
                    });
                    return;
                }

                // å‡†å¤‡å›¾è¡¨æ•°æ®
                const dailyData = this.groupByDay(this.history);
                const dates = Object.keys(dailyData).sort();
                const queryCounts = dates.map(date => dailyData[date].count);
                const avgBalances = dates.map(date => dailyData[date].avgBalance);

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#319795',
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    legend: {
                        data: ['æŸ¥è¯¢æ¬¡æ•°', 'å¹³å‡ä½™é¢'],
                        textStyle: {
                            color: '#9CA3AF'
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLine: {
                            lineStyle: {
                                color: '#4B5563'
                            }
                        },
                        axisLabel: {
                            color: '#9CA3AF'
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: 'æŸ¥è¯¢æ¬¡æ•°',
                            position: 'left',
                            axisLine: {
                                lineStyle: {
                                    color: '#319795'
                                }
                            },
                            axisLabel: {
                                color: '#9CA3AF'
                            }
                        },
                        {
                            type: 'value',
                            name: 'å¹³å‡ä½™é¢ (TARA)',
                            position: 'right',
                            axisLine: {
                                lineStyle: {
                                    color: '#ed8936'
                                }
                            },
                            axisLabel: {
                                color: '#9CA3AF'
                            }
                        }
                    ],
                    series: [
                        {
                            name: 'æŸ¥è¯¢æ¬¡æ•°',
                            type: 'bar',
                            data: queryCounts,
                            itemStyle: {
                                color: '#319795'
                            }
                        },
                        {
                            name: 'å¹³å‡ä½™é¢',
                            type: 'line',
                            yAxisIndex: 1,
                            data: avgBalances,
                            lineStyle: {
                                color: '#ed8936'
                            },
                            itemStyle: {
                                color: '#ed8936'
                            }
                        }
                    ]
                };

                this.chart.setOption(option);

                // å“åº”çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    this.chart.resize();
                });
            }

            groupByDay(history) {
                const groups = {};
                
                history.forEach(item => {
                    const date = new Date(item.timestamp).toISOString().split('T')[0];
                    if (!groups[date]) {
                        groups[date] = {
                            count: 0,
                            totalBalance: 0,
                            avgBalance: 0
                        };
                    }
                    groups[date].count++;
                    groups[date].totalBalance += item.balance;
                    groups[date].avgBalance = groups[date].totalBalance / groups[date].count;
                });

                return groups;
            }

            exportHistory() {
                if (this.history.length === 0) {
                    this.showMessage('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
                    return;
                }

                const csvContent = this.convertToCSV(this.history);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `taraxa-query-history-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    this.showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
                }
            }

            convertToCSV(history) {
                const headers = ['æŸ¥è¯¢æ—¶é—´', 'é’±åŒ…åœ°å€', 'ä½™é¢ (TARA)'];
                const rows = history.map(item => [
                    new Date(item.timestamp).toLocaleString(),
                    item.address,
                    item.balance.toFixed(6)
                ]);

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            clearHistory() {
                if (this.history.length === 0) {
                    this.showMessage('æš‚æ— è®°å½•å¯æ¸…ç©º', 'warning');
                    return;
                }

                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    this.history = [];
                    this.filteredHistory = [];
                    this.saveHistory();
                    this.updateStatistics();
                    this.renderHistoryList();
                    this.initChart();
                    this.showMessage('å†å²è®°å½•å·²æ¸…ç©º', 'success');
                }
            }

            requeryAddress(address) {
                // è·³è½¬åˆ°é¦–é¡µå¹¶å¡«å……åœ°å€
                localStorage.setItem('requery-address', address);
                window.location.href = 'index.html';
            }

            async copyAddress(address) {
                try {
                    await navigator.clipboard.writeText(address);
                    this.showMessage('åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    this.showMessage('å¤åˆ¶å¤±è´¥', 'error');
                }
            }

            showMessage(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };

                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-20 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.classList.remove('translate-x-full');
                }, 100);
                
                setTimeout(() => {
                    messageDiv.classList.add('translate-x-full');
                    setTimeout(() => {
                        document.body.removeChild(messageDiv);
                    }, 300);
                }, 3000);
            }

            animateElements() {
                const cards = document.querySelectorAll('.glass-effect');
                cards.forEach((card, index) => {
                    anime({
                        targets: card,
                        translateY: [50, 0],
                        opacity: [0, 1],
                        duration: 800,
                        delay: index * 100,
                        easing: 'easeOutQuart'
                    });
                });
            }
        }

        // åˆå§‹åŒ–å†å²è®°å½•ç®¡ç†å™¨
        document.addEventListener('DOMContentLoaded', () => {
            window.historyManager = new HistoryManager();
        });
    </script>
</body>
</html>